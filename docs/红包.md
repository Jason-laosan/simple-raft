# 红包功能概要

## 核心能力
- **红包类型**：支持拼手气（随机金额）与固定金额。
- **数量限制**：每个红包最多 500 人领取。
- **超时回收**：红包 30 分钟未领取完自动回收剩余金额并退回发起人。
- **高并发目标**：系统需支撑 10,000 TPS。
- **技术依赖**：MySQL 持久化、Redis 缓存/Lua 脚本、MQ（Kafka/RabbitMQ）异步事件。

## 架构模块
1. **RedPacket Service**：创建校验、金额拆分（固定/拼手气）、写入数据库与缓存。
2. **Grab Service**：通过 Redis Lua 原子扣减份额并保障人数阈值与幂等，结果异步落库。
3. **Recycle Job**：基于 TTL/延时队列回收过期红包，并触发退款。
4. **Account Service**：负责资金冻结、扣款、退款，与红包系统通过本地消息表 + MQ 保持一致。
5. **监控与限流**：Gateway/Service 层限流、熔断，Prometheus 监控 Lua 成功率、回收金额等指标。

## 数据与缓存
- **MySQL 表**：`red_packet`（红包主信息）、`red_packet_portion`（拆分份额）、`red_packet_grab`（领取记录）、`outbox_event`（事务消息）。
- **Redis Key**：
  - `rp:{packetId}:pool` 保存剩余份额；
  - `rp:{packetId}:count` 计数领取人数；
  - `rp:{packetId}:records` 记录用户领取金额；
  - `rp:{packetId}:state` 缓存状态与剩余金额；
  - `rp:{packetId}:ttl` 过期时间，驱动回收任务。

## 流程摘要
1. **发红包**：参数校验 → 拆分金额 → 落库 → 写 Redis → 扣减资金。
2. **抢红包**：检测状态 → Lua 执行（人数、金额原子扣减）→ 缓存记录 → 异步写库。
3. **回收**：TTL 到期或定时任务扫描 → 读取剩余金额 → 退款 → 更新状态/清理缓存。

## 扩展建议
- 建立全链路 Trace 与压测脚本验证 500 人并发场景。
- 增加对账任务比对 Redis 剩余份额与数据库金额。
- 对回收与资金接口提供补偿任务，确保极端情况下仍可恢复。
