# DCIM（数据中心基础设施管理）系统架构设计（数据采集层基于Golang）

## 一、架构设计总览

### 1. 设计目标

DCIM系统聚焦数据中心基础设施（机柜、UPS、精密空调、PDU、温湿度传感器、服务器/网络设备等）的全生命周期管理，核心实现**实时监控、故障告警、资产盘点、能耗分析、容量规划**五大核心能力。本次架构明确数据采集层强制使用Golang开发，充分利用其高并发、轻量级、跨平台（适配数据中心多类操作系统）、原生支持网络编程的特性。

### 2. 整体架构分层

采用经典的分层+微服务架构，共分为6层，整体遵循“采集-传输-存储-计算-应用-展示”全链路设计：

|层级|核心职责|技术栈（核心）|
|---|---|---|
|采集层（Golang）|多协议设备数据采集、边缘计算（数据清洗/聚合）、采集任务调度|Golang + 各类工业/网络协议库|
|传输层|数据可靠传输、协议转换、流量控制、断点续传|MQTT/AMQP + HTTP/HTTPS + gRPC|
|存储层|时序数据存储、结构化数据存储、文件存储、缓存|InfluxDB/TimescaleDB + PostgreSQL + Redis + MinIO|
|计算层（核心服务）|数据聚合分析、告警规则引擎、资产管理、能耗计算、容量规划|Java（SpringBoot）/Golang（核心服务）|
|应用层|业务逻辑编排、API网关、权限控制、第三方集成|SpringCloud/Golang Gin + Nginx（网关）|
|展示层|可视化大屏、Web管理端、移动端、报表导出|Vue3 + ECharts + Uniapp|
### 3. 架构拓扑图（文字版）

```Plain Text

```

## 二、核心分层详细设计

### 1. 采集层（强制Golang开发）

#### 1.1 设计原则

- **轻量化**：采集Agent体积＜10MB，无依赖部署（Golang编译为单二进制文件）；

- **高并发**：单Agent支持同时采集≥1000台设备；

- **高可用**：断线重连、采集任务失败重试、本地缓存（断网时缓存数据，联网后补发）；

- **可扩展**：插件化设计，新增设备协议仅需开发插件，无需修改核心Agent。

#### 1.2 核心组件

|组件|职责|Golang核心技术/库|
|---|---|---|
|采集Agent（核心）|部署在数据中心边缘节点/服务器，执行采集任务|Go协程（goroutine）+ 上下文（context）|
|协议插件管理器|加载/卸载各类设备协议插件|Go插件（plugin）/动态链接库|
|数据预处理模块|数据清洗（去重/格式转换）、单位换算、异常值过滤、本地缓存|Go内置容器 + badger（轻量级本地KV存储）|
|任务调度模块|按配置的采集频率（秒级/分钟级）触发采集任务|cron（定时任务）+ 分布式锁（Redis）|
|心跳与管控模块|接收服务端指令（修改采集频率/新增设备）、上报Agent状态|gRPC + WebSocket|
#### 1.3 支持的采集协议（Golang实现）

|协议类型|适用设备|Golang实现库|
|---|---|---|
|SNMP（v1/v2c/v3）|网络设备（交换机/路由器）、PDU、UPS、空调|gosnmp|
|IPMI|服务器（物理机）|freeipmi（Golang封装）/ goipmi|
|Modbus（TCP/RTU）|温湿度传感器、智能电表、精密空调|modbus|
|HTTP/RESTful|智能PDU、云化设备|net/http（Go原生）+ gin|
|SSH/Telnet|服务器/网络设备命令行采集|[golang.org/x/crypto/ssh](http://golang.org/x/crypto/ssh) + telnet|
|BACnet/IP|楼宇自控、空调系统|go-bacnet|
#### 1.4 采集流程（Golang）

1. 服务端通过gRPC下发采集任务（设备IP/协议/采集项/频率）到Agent；

2. Agent的任务调度模块按频率触发采集；

3. 协议插件加载对应协议驱动，与设备建立连接并读取数据；

4. 数据预处理模块清洗数据，异常值标记为“无效”，有效数据先写入本地badger缓存；

5. 数据通过MQTT（QoS=1）上报至消息队列，上报成功后清理本地缓存；

6. 若上报失败，Agent缓存数据，按指数退避策略重试，最大缓存时长24小时；

7. Agent每30秒向服务端上报自身状态（CPU/内存/采集任务执行情况）。

#### 1.5 Golang采集Agent核心代码骨架

```Go

```

### 2. 传输层

#### 2.1 核心设计

- **双传输模式**：

    - 实时采集数据：MQTT（QoS=1，保证消息至少送达一次），适配秒级高频采集数据；

    - 批量/大文件数据（如设备配置备份）：HTTP/HTTPS + 断点续传，适配大体积数据；

    - 服务端与Agent指令交互：gRPC（高性能二进制传输），适配双向指令通信。

- **传输网关**：统一接收各Agent上报数据，做协议转换（MQTT→HTTP/gRPC）、流量控制（限流/削峰）、数据加密（TLS 1.3）。

#### 2.2 关键组件

- MQTT Broker：EMQ X（开源高可用，支持集群），部署在核心机房，接收Agent上报数据；

- 传输网关：Golang开发，集成限流（令牌桶算法）、加密、数据校验逻辑；

- 断点续传服务：记录大文件传输进度，支持断网后从断点继续传输。

### 3. 存储层

#### 3.1 存储选型与分工

|存储类型|选型|存储内容|
|---|---|---|
|时序数据库|InfluxDB 2.x|设备实时监控数据（温湿度、电压、电流、功率、CPU/内存使用率等），按时间维度存储|
|关系型数据库|PostgreSQL + PostGIS|结构化数据（资产信息、告警规则、用户权限、机柜布局、数据中心拓扑等），PostGIS存储地理信息（机房/机柜位置）|
|缓存数据库|Redis Cluster|热点数据（实时监控大屏数据、Agent状态、最近1小时告警）、分布式锁、任务队列|
|对象存储|MinIO|设备图片/文档（机柜照片、设备手册）、采集日志、报表文件、备份数据|
#### 3.2 数据存储策略

- 时序数据：按“数据中心-机房-机柜-设备”维度分库分表，保留策略：秒级数据保留3个月，分钟级聚合数据保留1年，小时级聚合数据保留3年；

- 结构化数据：按租户分表（多租户场景），开启事务和索引优化（设备ID、资产编号等字段）；

- 缓存数据：热点数据TTL=5分钟，Agent状态TTL=30秒，告警数据TTL=24小时。

### 4. 计算层（核心服务，微服务化）

采用“Java为主、Golang为辅”的技术栈，核心服务拆分如下：

|微服务|职责|技术栈|
|---|---|---|
|采集管理服务|管理采集Agent、下发采集任务、配置采集策略、监控Agent状态|Golang（Gin）+ gRPC|
|数据处理服务|接收采集数据、二次清洗、聚合计算（如能耗总和、平均温度）、数据标准化|Golang（高并发处理）+ 流处理|
|资产管服务|设备资产入库/出库/调拨、生命周期管理、资产台账、资产关联（设备-机柜）|Java（SpringBoot）+ MyBatis|
|告警服务|告警规则配置、实时告警检测、告警分级（紧急/重要/普通）、告警升级|Java（SpringBoot）+ Drools规则引擎|
|能耗分析服务|能耗数据统计（按机房/机柜/设备）、能耗趋势分析、节能建议生成|Java + Apache Spark（离线分析）|
|容量规划服务|机柜U位/功率容量、机房空间/电力容量、容量预警、扩容建议|Java + 机器学习（趋势预测）|
### 5. 应用层

#### 5.1 核心组件

- **API网关**：Nginx + Kong，统一入口，负责路由、鉴权、限流、日志、跨域；

- **权限中心**：基于RBAC模型，管理用户/角色/权限，对接LDAP/AD（企业级认证）；

- **集成服务**：提供OpenAPI，支持对接动环监控、工单系统、CMDB、财务系统；

- **任务调度中心**：XXL-Job，调度批量任务（如资产盘点、报表生成、数据归档）。

#### 5.2 API设计规范

- 接口风格：RESTful + OpenAPI 3.0文档；

- 数据格式：JSON（统一字符集UTF-8）；

- 鉴权方式：JWT Token（短期）+ API Key（长期集成）；

- 版本控制：URL携带版本（如`/api/v1/asset/query`）。

### 6. 展示层

#### 6.1 终端类型

|终端|核心功能|技术栈|
|---|---|---|
|Web管理端|资产配置、采集策略配置、告警规则配置、报表查询、设备详情查看|Vue3 + Element Plus + Vue Router|
|监控大屏|数据中心全景监控（温湿度、能耗、告警、设备状态）、可视化拓扑、实时刷新|Vue3 + ECharts + DataV|
|移动端（H5/APP）|告警推送、移动巡检、设备扫码、快速查看设备状态|Uniapp + Vue3|
|报表中心|自定义报表、定时报表、导出（Excel/PDF）、数据可视化下载|SpringBoot + POI + ECharts导出|
## 三、非功能设计

### 1. 高可用设计

- **采集层**：Agent本地缓存 + 断线重连，支持多Agent部署（主备），单Agent故障不影响设备采集；

- **传输层**：MQTT Broker集群（主从+分片），传输网关双机热备；

- **存储层**：时序库/关系库主从复制 + 定时备份，Redis集群（主从+哨兵）；

- **服务层**：微服务集群部署（≥2实例），K8s容器编排，自动扩缩容；

- **网络**：数据中心双链路，采集网络与业务网络隔离，避免单点故障。

### 2. 性能设计

- **采集层**：Golang协程池（控制并发数），单Agent支持1000+设备并发采集，采集频率最低1秒；

- **传输层**：MQTT批量消息发送，减少网络IO；

- **存储层**：时序库按时间分区，关系库索引优化，缓存热点数据；

- **服务层**：接口异步化（异步处理非实时任务），批量接口分页，避免大数据量一次性返回。

### 3. 安全设计

- **采集层**：Agent与服务端通信加密（TLS 1.3），设备采集账号最小权限；

- **传输层**：MQTT认证（用户名+密码），数据传输加密，禁止明文传输；

- **存储层**：敏感数据加密存储（如设备密码、API Key），数据库审计日志；

- **应用层**：接口鉴权、防SQL注入/跨站脚本（XSS）/CSRF，操作日志全记录；

- **运维**：Agent远程升级需校验签名，禁止未授权修改采集配置。

### 4. 可扩展设计

- **采集层**：插件化协议支持，新增设备协议仅需开发Golang插件，无需重启Agent；

- **服务层**：微服务按业务域拆分，支持独立扩容，新增服务仅需注册到注册中心；

- **存储层**：支持时序库/关系库横向扩展，适配数据量增长；

- **展示层**：前端组件化设计，新增页面/功能模块无需重构整体架构。

## 四、部署架构

### 1. 部署模式

- **采集Agent**：轻量化部署，支持物理机/容器/虚拟机，按机房部署（每机房1~2台Agent）；

- **核心服务**：K8s集群部署（生产环境），支持自动扩缩容；

- **存储集群**：独立物理机部署，高性能磁盘（SSD），RAID 5/6保障数据安全；

- **展示层**：Web服务容器化部署，CDN加速静态资源（大屏/前端页面）。

### 2. 部署拓扑（按数据中心维度）

```Plain Text

```

## 五、核心流程示例

### 1. 设备数据采集-监控-告警全流程

1. 管理员在Web端配置设备采集策略（IP=[192.168.1.100](192.168.1.100)，协议=SNMP，采集项=温湿度，频率=10秒）；

2. 采集管理服务通过gRPC将策略下发至对应机房的Golang采集Agent；

3. Agent的任务调度模块每10秒触发采集，通过SNMP插件读取设备温湿度数据；

4. Agent清洗数据（过滤异常值），本地缓存后通过MQTT上报至消息队列；

5. 数据处理服务消费MQTT消息，将数据写入InfluxDB，并同步至Redis（供大屏展示）；

6. 告警服务实时检测数据，若温度＞28℃，触发“重要告警”；

7. 告警服务通过短信/钉钉/邮件推送告警至运维人员；

8. 运维人员通过移动端查看告警，确认后在系统中标记告警状态。

### 2. 资产入库流程

1. 运维人员在Web端录入设备信息（型号、厂商、序列号、所属机房/机柜）；

2. 资产服务校验数据，写入PostgreSQL，并生成唯一资产编号；

3. 采集管理服务自动关联采集Agent，新增该设备的采集任务；

4. Agent开始采集设备数据，资产台账与实时监控数据关联展示。

## 六、技术选型总结

|维度|核心技术选型|选型理由|
|---|---|---|
|采集层|Golang + 各类协议库 + badger|高并发、轻量化、跨平台、原生支持网络编程，适配数据中心多设备协议采集|
|传输层|EMQ X（MQTT）+ gRPC + Nginx|低延迟、高可靠、适配物联网设备采集场景，gRPC适配服务端-Agent指令交互|
|存储层|InfluxDB + PostgreSQL + Redis + MinIO|时序库适配监控数据，关系库适配结构化数据，缓存提升性能，对象存储适配文件|
|计算层|Java（SpringBoot）+ Golang|Java生态成熟适配业务系统，Golang适配高并发数据处理|
|展示层|Vue3 + ECharts + Uniapp|前端生态成熟，适配多终端展示，可视化组件丰富|
|部署运维|K8s + Docker + Prometheus + Grafana|容器化部署易扩展，监控体系完善，适配微服务架构|
## 七、扩展建议

1. **AI能力集成**：基于采集的历史数据，训练设备故障预测模型（如UPS电池寿命、空调故障），提升主动运维能力；

2. **边缘计算增强**：在Golang采集Agent中增加边缘分析能力（如本地告警、本地数据聚合），减少核心区计算压力；

3. **国产化适配**：逐步替换为国产化数据库（如人大金仓）、操作系统（统信/UOS）、中间件，满足信创要求；

4. **API生态建设**：开放更多API，对接第三方工具（如运维自动化平台、能耗管理平台），打造数据中心一体化管理体系。
> （注：文档部分内容可能由 AI 生成）